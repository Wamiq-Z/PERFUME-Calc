{% extends "base.html" %} {% block content %}
<h2>Perfume Calculator</h2>
<script>
async function removeCompound(compoundId) {
  try {
    const response = await fetch(`/remove_from_calculator/${compoundId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      }
    });

    if (response.ok) {
      const btn = document.querySelector(`button[data-id="${compoundId}"]`);
      const row = btn.closest("tr");
      row.remove();
    } else {
      console.error("Failed to remove compound");
    }
  } catch (err) {
    console.error("Error:", err);
  }
}
</script>
<div class="search-container">
  <input 
    type="text" 
    id="search-bar" 
    placeholder="ðŸ” Search compounds..."
  />
  <ul id="search-results"></ul>
</div>
<form method="post" action="{{ url_for('calc') }}">
  <table class="lux-table">
  <thead>
    <tr>
      <th>Compound</th>
      <th>Price/kg</th>
      <th>Quantity (kg)</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for compound in compounds %}
    <tr>
      <td>{{ compound.name }}</td>
      <td>Rs. {{ compound.price_perkg }}</td>
      <td>
        <div class="quantity-input">
            <input
              type="number"
              step="0.01"
              name="{{ compound.id }}"
              value="{{ request.form.get(compound.id | string, '') }}"
              class="lux-input"
            />
            <select name="{{ compound.id }}_unit" class="lux-select">
              <option value="kg" {% if request.form.get(compound.id ~ '_unit', 'kg') == 'kg' %}selected{% endif %}>kg</option>
              <option value="g" {% if request.form.get(compound.id ~ '_unit') == 'g' %}selected{% endif %}>g</option>
            </select>
          </div>
      </td>
      <td>
        <button type="button" 
                class="btn btn-remove" 
                data-id="{{ compound.id }}" 
                onclick="removeCompound({{ compound.id }})">
          Remove
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

  <div class="button-group">
  <button class="btn btn-remove" 
          type="submit" 
          name="clear_all" 
          value="1">
    Clear All
  </button>
  <button class="btn btn-add" type="submit">Calculate</button>
</div>
</form>

{% if selected %}
<div class="selected-section">
  <div class="selected-box">
    <h3>Selected Compounds</h3>
    <ul class="compound-list">
      {% for name, qty, price_kg, price in selected %}
      <li class="compound-item">
        <span class="compound-name">{{ name }} --> </span>
        <span class="compound-details">
          {{ "%.4f"|format(qty) }} kg Ã— Rs. {{ price_kg }} = 
          <strong>Rs. {{ "%.2f" | format (price) }} </strong>
        </span>
      </li>
      {% endfor %}
    </ul>
  </div>

  <!-- Right: Totals Table -->
  <div class="summary-box">
    <h3>Summary</h3>
    <table class="summary-table">
      <tr>
        <th>Total Quantity</th>
        <td>{{ "%.2f"|format(total_quantity) }} kgs</td>
      </tr>
      <tr>
        <th>Quantity in grams</th>
        <td>{{ "%.2f"|format(total_qty_g) }} g</td>
      </tr>
      <tr>
        <th>Price per kg</th>
        <td>Rs. {{ "%.2f"|format(avg_price_per_kg) }}</td>
      </tr>
      <tr>
        <th>Total Price</th>
        <td><strong>Rs. {{ "%.2f"|format(total) }}</strong></td>
      </tr>
    </table>
  </div>
</div>
{% endif %}
<script>
  document
    .getElementById("search-bar")
    .addEventListener("input", async function () {
      const query = this.value;
      if (query.length < 2) {
        document.getElementById("search-results").innerHTML = "";
        return;
      }

      const res = await fetch(`/search_compounds?q=${query}`);
      const data = await res.json();

      let resultsHtml = "";
      data.forEach((c) => {
        resultsHtml += `
          <li>
            ${c.name} â€” â‚¹${c.price}
            <div style="display: inline-flex; gap: 8px; margin-left: 10px;">
            <a href="/edit/${c.id}">
              <button class="btn btn-edit">Edit</button>
            </a>
            ${
              c.added
                ? `<span  class="status-added">Added</span>`
                : `<button data-id="${c.id}" 
                onclick="addCompound(${c.id})">Add</button>`
            }
          </li>
        `;
      });
      document.getElementById("search-results").innerHTML = resultsHtml;
    });
  
  async function addCompound(compoundId) {
    const res = await fetch("/add_search", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: compoundId })
    });

    const data = await res.json();
    if (data.success) {
      // Replace Add button with "Added"
      const btn = document.querySelector(`button[data-id="${compoundId}"]`);
      if (btn) {
        btn.outerHTML = `<span class="status-added">Added</span>`;
      }

      // Now update the calculator table dynamically
      const tableBody = document.querySelector(".lux-table tbody");

      // Avoid duplicate row if already exists
      if (!document.querySelector(`tr[data-row-id="${compoundId}"]`)) {
        const newRow = document.createElement("tr");
        newRow.setAttribute("data-row-id", compoundId);
        newRow.innerHTML = `
          <td>${data.compound.name}</td>
          <td>Rs. ${data.compound.price}</td>
          <td>
            <div class="quantity-input">
              <input type="number" step="0.01" 
                    name="${compoundId}" 
                    value="" class="lux-input" />
              <select name="${compoundId}_unit" class="lux-select">
                <option value="kg" selected>kg</option>
                <option value="g">g</option>
              </select>
            </div>
          </td>
          <td>
            <button type="button" class="btn btn-remove" 
                    data-id="${compoundId}" 
                    onclick="removeCompound(${compoundId})">
              Remove
            </button>
          </td>
        `;
        tableBody.appendChild(newRow);
      }
    } else {
      alert(data.message || "Failed to add compound");
    }
}
  </script>
{% endblock %}
